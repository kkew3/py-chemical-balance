# 配平化学方程式

## 基本原理

将化学方程式转化为系数矩阵，配平即为求系数矩阵所蕴含的齐次方程组的非平凡解。存在非平凡解的充要条件是矩阵的列数减去矩阵的秩（即零空间的维数）大于零。非平凡解若存在即为无穷多个，但线性无关的非平凡解的数目一定为零空间的维数。要想求得线性无关的非平凡解，只需通过高斯消元法得到零空间的一组基即可。

## 限制条件

配平方程式，除了不能是平凡解，解的每个元素还必须至少为 1。因此上文求得的解的数目（可能）只是实际解数目的上界。目前我还没办法证明零空间的维数同时也是实际解数目的下界，也不知道如何通过零空间的一组基通过基变换求出满足配平条件的一组配平系数，甚至不知道是否存在这样的基变换。实际运行中只能说，如果*碰巧*基的系数都至少为 1，那么就算求出所有线性无关的配平系数；如果有些基的系数非正，那么只能舍去它们，求出一部分配平系数。

然而如果勉强一点其实可以在基的系数非正时尝试构造另一组尽可能正的基，从而配平。为了做到基变换，需要非奇异矩阵作为转移矩阵。恰好，各元素服从标准正态分布的方阵的 QR 分解中的 Q 矩阵为规范正交矩阵，即为非奇异矩阵。我们可以随机很多这样的转移矩阵，然后选一个最好的，即使尽可能多的变换后的基向量元素全为正。这种方法的缺点是不能找到系数最小的配平。是的，即使系数间没有公约数，它们也不是最小的。而且顺带一个当配平系数非常大时因浮点运算精度问题导致的配平错误的问题。

## 实现方法

我使用状态机解析形如 `H2 + O2 = H2O` 的化学方程式为系数矩阵。我使用[全选主元法](https://math.stackexchange.com/questions/1334983/gauss-elimination-difference-between-partial-and-complete-pivoting)实现高斯消元法，得到行最简形并顺便得到矩阵的秩。高斯消元法由 Cython 实现。我使用 Cython 实现了随机搜索转移矩阵的方法。

## 使用

准备工作：

```bash
# 建立虚拟环境（可选）
#python3 -m virtualenv rt
#. rt/bin/activate

# 下载依赖并编译 Cython 模块
pip3 install -r requirements.txt
python setup.py build_ext --inplace
```

使用范例：

```bash
(rt) $ python3 solveeq.py H2 + O2 = H2O
2 1 2
(rt) $ python3 solveeq.py NH3 + H2S = "(NH4)2S"
2 1 1
(rt) $ python3 solveeq.py P4 + P2I4 + H2O = PH4I + H3PO4
13 10 128 40 32
(rt) $ python3 solveeq.py XeF4 + H2O = XeO3 + Xe + O2 + HF
43979496977280 87958993954560 619006757837223 -575027289857432 -884530672872372 175917987909120
2157757012086033133048 4315513013542866057000 294129042350223383745 1863627689969916032160 1716563276124831513600 8631026808032207765160
(rt) $ python3 solveeq.py -N100 --decimal XeF4 + H2O = XeO3 + Xe + O2 + HF
0.03214082617297417 0.06428165234594833 0.6825614202267063 -0.6504205940537322 -0.9917013041670855 0.12856330469189667
0.24792532604177142 0.49585065208354284 0.0795746808999165 0.1683506451418549 0.12856330469189667 0.9917013041670857
```

其中最后两个有两种（线性无关的）配平方式，但用现有方法只能找出一个非最优配平。倒数第二个因精度问题是错误的，最后一个允许小数系数，是正确的。顺便说一下，最后一个的两种最优配平分别为：`6 12 2 4 3 24` 和 `4 8 2 2 1 16`。
